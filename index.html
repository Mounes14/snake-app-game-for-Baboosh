<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ù„Ù…Ø±ÙŠÙ… Ø§Ù„Ø¨Ø§Ø¨ÙˆÙˆÙˆÙˆÙˆØ´</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f7c5ff"/>
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <style>
    :root {
      --bg: #fff7ff;
      --board: #ffeaff;
      --snake: #5e2a7f;
      --food: #ff6fb5;
      --accent: #b084d9;
      --text: #3a2a3a;
    }
    .theme-labubu {
      --bg: #fff9f0;
      --board: #fff1db;
      --snake: #503b2d;
      --food: #ff9a3c;
      --accent: #b68b5b;
      --text: #3a2b20;
    }
    .theme-melody {
      --bg: #fff4f6;
      --board: #ffe6ec;
      --snake: #c04a6b;
      --food: #ff8fb1;
      --accent: #f9a8d4;
      --text: #4a2430;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Noto Sans Arabic', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }
    header, footer {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    header h1 { font-size: 1.1rem; margin: 0; }
    button {
      border: 0; background: var(--accent); color: #fff;
      padding: 8px 12px; border-radius: 10px; font-weight: 700;
    }
    .ghost { background: transparent; color: var(--text); border: 2px solid var(--accent); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .pill { background: var(--board); padding: 6px 10px; border-radius: 999px; font-weight: 700; }
    .stat { font-weight: 800; }
    #boardWrap { display: grid; place-items: center; padding: 6px; }
    canvas {
      background: var(--board);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      touch-action: none;
      width: min(92vw, 520px);
      height: min(92vw, 520px);
      image-rendering: pixelated;
    }
    dialog::backdrop { background: rgba(0,0,0,.25); }
    dialog { border: none; border-radius: 16px; padding: 0; max-width: 580px; width: calc(100% - 28px); box-shadow: 0 20px 60px rgba(0,0,0,.25); }
    .card { padding: 18px; }
    .title { font-size: 1.3rem; font-weight: 900; }
    .note { opacity: .9; }
    #screenpad {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      grid-template-rows: repeat(3, 80px);
      gap: 8px;
      place-content: center;
      margin: 8px auto 12px;
    }
    #screenpad button { height: 80px; border-radius: 12px; border: 0; background: var(--board); font-size: 1.2rem; font-weight: 800; }
    @media (min-width: 720px) { #screenpad { display: none; } }
    .toast { position: fixed; bottom: 10px; left: 10px; background: #000; color: #fff; padding: 8px 10px; border-radius: 8px; opacity: .92; }
    .hint { font-size: .9rem; opacity: .8; }
  </style>
</head>
<body class="theme-kurumi">
  <header>
    <h1>ğŸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ù„Ù…Ø±ÙŠÙ… Ø§Ù„Ø¨Ø§Ø¨ÙˆØ´</h1>
    <div class="row">
      <button id="i18nBtn" class="ghost" title="Language">AR</button>
      <button id="themeBtn" title="Theme">Ø­Ø²Ù…Ø© ÙƒÙˆØ±ÙˆÙ…ÙŠ</button>
      <button id="calmBtn" title="Calm Mode">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§Ø¯Ø¦: Ù…ÙØ¹Ù„</button>
      <button id="soundBtn" title="Sounds">Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„</button>
      <button id="dedicationBtn" title="Dedication">Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ ğŸ’Œ</button>
      <button id="settingsBtn" class="ghost" title="Settings">âš™ï¸</button>
    </div>
  </header>

  <div id="hud" class="row" style="justify-content: space-between; padding: 0 14px;">
    <div class="row">
      <div class="pill"> Ø§Ù„Ù„Ø§Ø¹Ø¨ : Ù…Ø±ÙŠÙ… Ø§Ù„ÙƒØ´Ù…Ø´ ÙˆØ§Ù„Ù…Ø´Ù…Ø´</div>
      <div class="pill stat">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
      <div class="pill stat">Ø§Ù„Ø£ÙØ¶Ù„: <span id="best">0</span></div>
      <div class="pill stat">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></div>
    </div>
    <div class="row">
      <button id="startBtn">Ø§Ø¨Ø¯Ø£</button>
      <button id="pauseBtn">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
      <button id="photoBtn">ØµÙˆØ±Ø©</button>
    </div>
  </div>

  <div id="boardWrap">
    <canvas id="board" width="520" height="520" aria-label="Game board"></canvas>
  </div>

  <div id="screenpad" aria-hidden="false">
    <div></div><button data-dir="ArrowUp">â†‘</button><div></div>
    <button data-dir="ArrowLeft">â†</button><div></div><button data-dir="ArrowRight">â†’</button>
    <div></div><button data-dir="ArrowDown">â†“</button><div></div>
  </div>

 

  <dialog id="gift">
    <div class="card">
      <div class="title">Ø¥Ù„Ù‰ Ø¨Ø·Ù„ØªÙŠ Ø§Ù„Ø°ÙƒÙŠØ©ØŒ Ù…Ø±ÙŠÙ… ğŸ’œ</div>
      <p class="note"> Ø§ØªÙ…Ù†Ù‰ Ø§Ù† Ø§Ø±Ø§Ùƒ Ø§Ù†ØªÙŠ ÙˆØ§Ø®ØªÙƒ Ø§ÙØ¶Ù„ Ù…Ù†ÙŠ Ø¨ÙƒØ«ÙŠØ± ØŒ ØªØ¹Ù„Ù…ÙˆØ§ Ø¬ÙŠØ¯Ø§ ÙˆØ«Ø§Ø¨Ø±ÙˆØ§ Ø¬ÙŠØ¯Ø§ ÙŠØ§Ø¨Ø·Ø§Ù„ÙŠ ØŒ Ù…Ø¹ Ø­Ø¨ÙŠ ....Ø¨Ø§Ø¨Ø§ Ù…Ø¤Ù†Ø³</p>
      <div class="row" style="justify-content: space-between; margin-top: 6px;">
        <div class="row"><span class="pill">ÙƒÙˆØ±ÙˆÙ…ÙŠ</span><span class="pill">Ù„Ø§Ø¨ÙˆØ¨Ùˆ</span><span class="pill">Ù…ÙŠÙ„ÙˆØ¯ÙŠ</span></div>
        <button id="closeGift">Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ù„Ø¹Ø¨</button>
      </div>
    </div>
  </dialog>

  <dialog id="settings">
    <div class="card">
      <div class="title" data-i18n="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="row" style="margin-top: 8px;">
        <button id="resetBest" class="ghost">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙØ¶Ù„</button>
        <button id="installBtn">ØªØ«Ø¨ÙŠØª ÙƒÙ€ PWA</button>
      </div>
      <div class="row" style="justify-content: flex-end; margin-top: 10px;"><button id="closeSettings">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </dialog>

  <dialog id="photo">
    <div class="card">
      <div class="title">ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø©</div>
      <p class="note">Ø³Ù†Ø­ÙØ¸ Ù„Ù‚Ø·Ø© Ù…Ø¹ Ø¥Ø·Ø§Ø± ØµØºÙŠØ± ÙˆØ¥Ù‡Ø¯Ø§Ø¦Ùƒ.</p>
      <div class="row" style="justify-content: flex-end; margin-top: 8px;">
        <button id="snapBtn">Ø§Ù„ØªÙ‚Ø§Ø·</button>
        <button id="closePhoto">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </dialog>

  <script>
  let deferredPrompt = null;
  if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

  const i18nBtn = document.getElementById('i18nBtn');
  let lang = 'ar';
  const L = {
    ar: { start:'Ø§Ø¨Ø¯Ø£', pause:'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª', resume:'Ø§Ø³ØªØ¦Ù†Ø§Ù', calmOn:'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§Ø¯Ø¦: Ù…ÙØ¹Ù„', calmOff:'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§Ø¯Ø¦: Ù…Ø¹Ø·Ù„', theme:'Ø­Ø²Ù…Ø©', dedication:'Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ ğŸ’Œ', player:'Ø§Ù„Ù„Ø§Ø¹Ø¨: Ù…Ø±ÙŠÙ…', score:'Ø§Ù„Ù†Ù‚Ø§Ø·', best:'Ø§Ù„Ø£ÙØ¶Ù„', level:'Ø§Ù„Ù…Ø³ØªÙˆÙ‰', settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', install:'ØªØ«Ø¨ÙŠØª ÙƒÙ€ PWA', resetBest:'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙØ¶Ù„', photo:'ØµÙˆØ±Ø©', snap:'Ø§Ù„ØªÙ‚Ø§Ø·', giftTitle:'Ø¥Ù„Ù‰ Ù…ØºØ§Ù…Ø±ØªÙŠ Ø§Ù„Ø°ÙƒÙŠØ©ØŒ Ù…Ø±ÙŠÙ… ğŸ’œ', giftMsg:'Ø£ØªÙ…Ù†Ù‰ Ø£Ù† ØªØ¬Ø¯ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø§Ù„ÙƒØ±Ø² Ø§Ù„Ø­Ù„Ùˆ ÙˆØ§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù„Ø·ÙŠÙØ©. Ù…Ø¹ Ø§Ù„Ø­Ø¨ØŒ Ø¨Ø§Ø¨Ø§.', startPlay:'Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ù„Ø¹Ø¨', dad100:'Ù„Ø­Ø¸Ø© Ø¨Ø§Ø¨Ø§: ÙØ®ÙˆØ±Ø© Ø¨Ùƒ Ø¬Ø¯Ù‹Ø§!' },
    en: { start:'Start', pause:'Pause', resume:'Resume', calmOn:'Calm Mode: ON', calmOff:'Calm Mode: OFF', theme:'Kurumi Pack', dedication:'Dedication ğŸ’Œ', player:'Player: Maryam', score:'Score', best:'Best', level:'Level', settings:'Settings', install:'Install as PWA', resetBest:'Reset Best', photo:'Photo', snap:'Take Snapshot', giftTitle:'For my brilliant adventurer, Maryam ğŸ’œ', giftMsg:'May you always find sweet cherries and gentle turns. Love, Dad.', startPlay:'Start Playing', dad100:'Dad Moment: So proud of you!' }
  };
  function applyLang(){
    document.querySelector('html').lang = lang;
    document.querySelector('html').dir = (lang==='ar')?'rtl':'ltr';
    i18nBtn.textContent = (lang==='ar')?'AR':'EN';
    document.querySelector('#hud .row .pill').textContent = (lang==='ar')? 'Ø§Ù„Ù„Ø§Ø¹Ø¨: Ù…Ø±ÙŠÙ…' : 'Player: Maryam';
    document.querySelector('#photoBtn').textContent = L[lang].photo;
    document.querySelector('#startBtn').textContent = L[lang].start;
    document.querySelector('#pauseBtn').textContent = L[lang].pause;
    document.getElementById('calmBtn').textContent = calmMode ? L[lang].calmOn : L[lang].calmOff;
    document.getElementById('themeBtn').textContent = (lang==='ar')?'Ø­Ø²Ù…Ø© ÙƒÙˆØ±ÙˆÙ…ÙŠ':'Kurumi Pack';
    document.getElementById('dedicationBtn').textContent = L[lang].dedication;
    document.getElementById('soundBtn').textContent = soundOn ? (lang==='ar'?'Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„':'Sound: ON') : (lang==='ar'?'Ø§Ù„ØµÙˆØª: Ù…Ø¹Ø·Ù„':'Sound: OFF');
    document.querySelector('#settings .title').textContent = L[lang].settings;
    document.getElementById('installBtn').textContent = L[lang].install;
    document.getElementById('resetBest').textContent = L[lang].resetBest;
    document.querySelector('footer').textContent = (lang==='ar') ? 'ØªÙ„Ù…ÙŠØ­: Ù…Ø±Ø± Ø¨Ø¥ØµØ¨Ø¹Ùƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù…. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§Ø¯Ø¦ ÙŠØ¨Ù‚ÙŠ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø·ÙŠÙÙ‹Ø§ ğŸ’œ. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ¹Ù…Ù„ ÙƒØ£Ù†Ù‡Ø§ ØªØ·Ø¨ÙŠÙ‚.' : 'Tip: swipe or use arrows. Calm Mode keeps things gentle ğŸ’œ. Try Add to Home Screen for app-like feel.';
    gift.querySelector('.title').textContent = L[lang].giftTitle;
    gift.querySelector('.note').textContent = L[lang].giftMsg;
    gift.querySelector('#closeGift').textContent = L[lang].startPlay;
  }
  i18nBtn.addEventListener('click', () => { lang = (lang==='ar')?'en':'ar'; applyLang(); });

  const themes = ['theme-kurumi','theme-labubu','theme-melody'];
  let themeIndex = 0;
  const themeBtn = document.getElementById('themeBtn');
  function applyTheme() {
    document.body.classList.remove('theme-kurumi','theme-labubu','theme-melody');
    const cls = themes[themeIndex];
    document.body.classList.add(cls);
    const name = cls.split('-')[1];
    themeBtn.textContent = (lang==='ar' ? (name==='kurumi'?'ÙˆØ¶Ø¹ ÙƒÙˆØ±ÙˆÙ…ÙŠ': name==='labubu'?'ÙˆØ¶Ø¹ Ù„Ø§Ø¨ÙˆØ¨Ùˆ':'ÙˆØ¶Ø¹ Ù…ÙŠÙ„ÙˆØ¯ÙŠ') : name.charAt(0).toUpperCase()+name.slice(1)+' Theme');
  }
  themeBtn.addEventListener('click', () => { themeIndex = (themeIndex+1)%themes.length; applyTheme(); });
  applyTheme();

  const calmBtn = document.getElementById('calmBtn');
  let calmMode = true;
  calmBtn.addEventListener('click', () => { calmMode = !calmMode; calmBtn.textContent = calmMode ? L[lang].calmOn : L[lang].calmOff; });

  const soundBtn = document.getElementById('soundBtn');
  let soundOn = true;
  let ac;
  function beep(freq=600, dur=0.06){
    if (!soundOn) return;
    try {
      ac = ac || new (window.AudioContext || window.webkitAudioContext)();
      const o = ac.createOscillator(); const g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'sine'; o.frequency.value = freq;
      g.gain.value = 0.05;
      const now = ac.currentTime; o.start(now); o.stop(now+dur);
    } catch(e){}
  }
  soundBtn.addEventListener('click', () => { soundOn = !soundOn; soundBtn.textContent = soundOn ? (lang==='ar'?'Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„':'Sound: ON') : (lang==='ar'?'Ø§Ù„ØµÙˆØª: Ù…Ø¹Ø·Ù„':'Sound: OFF'); });

  const gift = document.getElementById('gift');
  const closeGift = document.getElementById('closeGift');
  gift.showModal();
  closeGift.addEventListener('click', () => gift.close());
  document.getElementById('dedicationBtn').addEventListener('click', () => gift.showModal());

  const settingsDlg = document.getElementById('settings');
  document.getElementById('settingsBtn').addEventListener('click', () => settingsDlg.showModal());
  document.getElementById('closeSettings').addEventListener('click', () => settingsDlg.close());
  document.getElementById('resetBest').addEventListener('click', () => { localStorage.removeItem('best_maryam'); best = 0; updateHUD(); toast(lang==='ar'?'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©':'Best score reset'); });
  document.getElementById('installBtn').addEventListener('click', async () => {
    if (!deferredPrompt) return toast(lang==='ar'?'ØºÙŠØ± Ù…ØªØ§Ø­ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­':'Install prompt not available');
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    toast(outcome === 'accepted' ? (lang==='ar'?'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª':'Installed') : (lang==='ar'?'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡':'Cancelled'));
    deferredPrompt = null;
  });

  const photoDlg = document.getElementById('photo');
  document.getElementById('photoBtn').addEventListener('click', () => photoDlg.showModal());
  document.getElementById('closePhoto').addEventListener('click', () => photoDlg.close());

  const cvs = document.getElementById('board');
  const ctx = cvs.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const levelEl = document.getElementById('level');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const snapBtn = document.getElementById('snapBtn');

  const CELL = 20;
  const COLS = Math.floor(cvs.width / CELL);
  const ROWS = Math.floor(cvs.height / CELL);

  let loopId = null;
  let tick = 0;
  let speed = 12;
  let level = 1;
  let score = 0;
  let best = +localStorage.getItem('best_maryam') || 0;

  const dirs = { ArrowUp:[0,-1], ArrowDown:[0,1], ArrowLeft:[-1,0], ArrowRight:[1,0] };
  let dir = 'ArrowRight';
  let nextDir = 'ArrowRight';

  let snake = [{x:5,y:5},{x:4,y:5},{x:3,y:5}];
  let food = spawnFood();
  let freezeLenTicks = 0;
  let passTailTicks = 0;

  function spawnFood() {
    let x, y; do { x = Math.floor(Math.random()*COLS); y = Math.floor(Math.random()*ROWS); } while(snake.some(s=>s.x===x && s.y===y));
    return {x,y, kind: Math.random()<0.85 ? 'fruit' : (Math.random()<0.6 ? 'heart' : 'star')};
  }

  function resetGame() {
    tick = 0; speed = calmMode ? 12 : 8;
    level = 1; score = 0;
    dir = 'ArrowRight'; nextDir = 'ArrowRight';
    snake = [{x:5,y:5},{x:4,y:5},{x:3,y:5}];
    food = spawnFood(); freezeLenTicks = 0; passTailTicks = 0;
    updateHUD(); draw();
  }

  function updateHUD() { scoreEl.textContent = score; bestEl.textContent = best; levelEl.textContent = level; }

  function gameLoop() {
    tick++; const pace = Math.max(3, speed - Math.floor(level/2));
    if (tick % pace === 0) step();
    draw(); loopId = requestAnimationFrame(gameLoop);
  }

  function step() {
    dir = validateTurn(dir, nextDir);
    const delta = dirs[dir];
    const head = { x: snake[0].x + delta[0], y: snake[0].y + delta[1] };

    if (calmMode) { head.x = (head.x + COLS) % COLS; head.y = (head.y + ROWS) % ROWS; }
    let hitWall = head.x<0 || head.y<0 || head.x>=COLS || head.y>=ROWS;
    let hitTail = snake.some(s => s.x===head.x && s.y===head.y);
    if (passTailTicks>0) hitTail = false;

    if (hitWall || hitTail) {
      if (calmMode) { snake.pop(); nextDir = (dir==='ArrowRight'?'ArrowLeft':dir==='ArrowLeft'?'ArrowRight':dir==='ArrowUp'?'ArrowDown':'ArrowUp'); return; }
      else { if (score>best) { best=score; localStorage.setItem('best_maryam', best); } toast(lang==='ar'?'Ø­Ø§ÙˆÙ„ØªÙ Ù…Ø¬Ø¯Ø¯Ù‹Ø§!':'Try again!'); resetGame(); return; }
    }

    snake.unshift(head);

    if (head.x===food.x && head.y===food.y) {
      if (food.kind==='fruit') { score += 10; beep(700,0.05); }
      else if (food.kind==='heart') { passTailTicks = 40; score += 5; beep(900,0.06); }
      else { freezeLenTicks = 40; score += 5; beep(500,0.06); }
      if (score>0 && score % 50 === 0) { level++; confetti(); beep(1200,0.08); }
      if (score === 100) toast((lang==='ar')?'Ù„Ø­Ø¸Ø© Ø¨Ø§Ø¨Ø§: ÙØ®ÙˆØ±Ø© Ø¨Ùƒ Ø¬Ø¯Ù‹Ø§!':'Dad Moment: So proud of you!');
      food = spawnFood();
    } else {
      if (freezeLenTicks<=0) snake.pop();
    }
    if (freezeLenTicks>0) freezeLenTicks--;
    if (passTailTicks>0) passTailTicks--;
    updateHUD();
  }

  function validateTurn(current, next) {
    const opp = {ArrowUp:'ArrowDown', ArrowDown:'ArrowUp', ArrowLeft:'ArrowRight', ArrowRight:'ArrowLeft'};
    return (next===opp[current]) ? current : next;
  }

  function _drawCore() {
    const w = cvs.width, h = cvs.height;
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha = 0.08;
    for (let x=0;x<w;x+=20) { ctx.fillStyle = '#000'; ctx.fillRect(x,0,1,h); }
    for (let y=0;y<h;y+=20) { ctx.fillStyle = '#000'; ctx.fillRect(0,y,w,1); }
    ctx.globalAlpha = 1;
    for (let i=0;i<snake.length;i++) {
      const s = snake[i];
      roundedRect(ctx, s.x*20+2, s.y*20+2, 16, 16, 6, getComputedStyle(document.body).getPropertyValue('--snake'));
      if (i===0) { ctx.fillStyle = 'rgba(255,255,255,.9)'; const cx = s.x*20, cy = s.y*20; ctx.fillRect(cx+11, cy+7, 3,3); ctx.fillRect(cx+14, cy+7, 3,3); }
    }
    const colorFruit = getComputedStyle(document.body).getPropertyValue('--food').trim();
    const colorAccent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
    if (food.kind==='fruit') drawCherry(food.x, food.y, colorFruit);
    else if (food.kind==='heart') drawHeart(food.x, food.y, colorAccent);
    else drawStar(food.x, food.y, colorAccent);
    if (calmMode) { ctx.globalAlpha = .7; ctx.font = 'bold 14px system-ui'; ctx.fillStyle = '#000'; ctx.fillText((lang==='ar')?'Ù‡Ø§Ø¯Ø¦':'Calm', 8, 18); ctx.globalAlpha = 1; }
  }
  function roundedRect(ctx, x, y, w, h, r, fill) {
    ctx.fillStyle = fill; ctx.beginPath(); ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r); ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r); ctx.arcTo(x, y, x+w, y, r); ctx.closePath(); ctx.fill();
  }
  function drawCherry(gx, gy, color) {
    const x = gx*20 + 10, y = gy*20 + 10;
    ctx.save(); ctx.translate(x,y); ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(-4,0,6,0,Math.PI*2); ctx.arc(6,0,6,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,.25)'; ctx.beginPath();
    ctx.moveTo(-2,-6); ctx.quadraticCurveTo(-6,-14, -8,-16);
    ctx.moveTo( 8,-6); ctx.quadraticCurveTo( 6,-14,  4,-16); ctx.stroke(); ctx.restore();
  }
  function drawHeart(gx, gy, color) {
    const x = gx*20 + 10, y = gy*20 + 10;
    ctx.save(); ctx.translate(x,y); ctx.fillStyle = color;
    ctx.beginPath(); ctx.moveTo(0,6); ctx.bezierCurveTo(12,-6, 10,-16, 0,-6); ctx.bezierCurveTo(-10,-16, -12,-6, 0,6); ctx.closePath(); ctx.fill(); ctx.restore();
  }
  function drawStar(gx, gy, color) {
    const x = gx*20 + 10, y = gy*20 + 10;
    ctx.save(); ctx.translate(x,y); ctx.fillStyle = color; ctx.beginPath();
    const spikes = 5, outer = 9, inner = 4; let rot = Math.PI / 2 * 3, cx = 0, cy = 0;
    ctx.moveTo(0,-outer);
    for (let i=0; i<spikes; i++) { cx = Math.cos(rot) * outer; cy = Math.sin(rot) * outer; ctx.lineTo(cx, cy); rot += Math.PI/spikes;
      cx = Math.cos(rot) * inner; cy = Math.sin(rot) * inner; ctx.lineTo(cx, cy); rot += Math.PI/spikes; }
    ctx.lineTo(0,-outer); ctx.closePath(); ctx.fill(); ctx.restore();
  }

  const confettiParts = [];
  function confetti() {
    for (let i=0;i<60;i++) { confettiParts.push({ x: Math.random()*cvs.width, y: -10, vx: (Math.random()-.5)*2, vy: Math.random()*2+1, life: 120 }); }
  }
  const drawCore = _drawCore;
  function draw(){ drawCore();
    if (confettiParts.length) {
      confettiParts.forEach(p => { ctx.fillStyle = ['#ff6fb5','#b084d9','#ff9a3c','#8dd3c7'][Math.floor(Math.random()*4)]; ctx.fillRect(p.x, p.y, 4, 6);
        p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.life--; });
      for (let i=confettiParts.length-1;i>=0;i--) if (confettiParts[i].life<=0 || confettiParts[i].y>cvs.height+10) confettiParts.splice(i,1);
    }
  }

  window.addEventListener('keydown', (e) => { if (dirs[e.key]) nextDir = e.key; });
  document.querySelectorAll('#screenpad [data-dir]').forEach(btn => { btn.addEventListener('click', () => { const k = btn.dataset.dir; if (dirs[k]) nextDir = k; }); });
  (function attachSwipe(el){ let sx=0, sy=0, t=0;
    el.addEventListener('touchstart', e => { const d=e.touches[0]; sx=d.clientX; sy=d.clientY; t=Date.now(); }, {passive:true});
    el.addEventListener('touchend', e => { const dx = e.changedTouches[0].clientX - sx; const dy = e.changedTouches[0].clientY - sy;
      if (Date.now()-t > 500) return;
      if (Math.abs(dx) > Math.abs(dy)) nextDir = dx>0?'ArrowRight':'ArrowLeft'; else nextDir = dy>0?'ArrowDown':'ArrowUp'; }, {passive:true}); })(cvs);

  startBtn.addEventListener('click', () => { if (loopId) cancelAnimationFrame(loopId); resetGame(); loopId = requestAnimationFrame(gameLoop); });
  pauseBtn.addEventListener('click', () => { if (loopId) { cancelAnimationFrame(loopId); loopId = null; pauseBtn.textContent = (lang==='ar')?'Ø§Ø³ØªØ¦Ù†Ø§Ù':'Resume'; } else { loopId = requestAnimationFrame(gameLoop); pauseBtn.textContent = (lang==='ar')?'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª':'Pause'; } });

  snapBtn.addEventListener('click', () => {
    const shot = document.createElement('canvas'); shot.width = cvs.width + 40; shot.height = cvs.height + 110;
    const sctx = shot.getContext('2d'); sctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--board'); sctx.fillRect(0,0,shot.width, shot.height);
    sctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text'); sctx.font = 'bold 20px system-ui';
    sctx.fillText((lang==='ar')?'Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ù„Ù…Ø±ÙŠÙ…':'Snake for Maryam', 16, 28);
    sctx.font = '14px system-ui';
    const ded = (lang==='ar')?'â€œØ£ØªÙ…Ù†Ù‰ Ø£Ù† ØªØ¬Ø¯ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø§Ù„ÙƒØ±Ø² Ø§Ù„Ø­Ù„Ùˆ ÙˆØ§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù„Ø·ÙŠÙØ©. Ù…Ø¹ Ø§Ù„Ø­Ø¨ØŒ Ø¨Ø§Ø¨Ø§.â€':'â€œMay you always find sweet cherries and gentle turns. Love, Dad.â€';
    sctx.fillText(ded, 16, 52); sctx.drawImage(cvs, 20, 80);
    const url = shot.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = 'snake-for-maryam-snapshot.png'; a.click();
  });

  function toast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 1600); }
  applyLang();
  </script>
</body>
</html>
